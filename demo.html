<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <style media="screen">
      canvas {
        border:solid 5px #999;
        background-color: #333333;
      }
    </style>
  </head>
  <body>
    <canvas id="lienzo" width="1000" height="600">
      Tu navegador no soporta canvas
    </canvas>
    <script type="text/javascript">
      var canvas, ctx, objetoActual = null, inicioX = 0, inicioY = 0, teclado = {};
      var objeto = [{
        x: 10,
        y: 10,
        width: 30,
        height: 100,
        color: 'grey'
      }]

      var esfera = {
        x: 350,
        y: 250,
        movx: 5,
        movy: 3,
        color: 'grey'
      }
      /*
      , {
        x: 100,
        y: 100,
        width: 50,
        height: 50,
        color: 'blue'
      }*/



      //Iniciamos socket.io
      var socket = io.connect();

      function update(array, context) {
        //Agregamos estas dos lineas para limpiar el canvas
        context.fillStyle = '#333333';
        context.fillRect(0,0,1000,600);

        //Agregamos la esfera
        context.beginPath();
        context.fillStyle = esfera.color;
        context.arc(esfera.x, esfera.y, 20, 0, 360,false);
        context.fill();

        //creamos un forEach donde vamos agregando cada elemento (player)
        array.forEach(function(entry) {
          context.save();
          context.fillStyle = entry.color;
          context.fillRect(entry.x, entry.y, entry.width, entry.height);
          context.restore();
        });
      }



      window.onload = function() {




        canvas = document.getElementById('lienzo');
        ctx = canvas.getContext('2d');

        socket.on('nuevo usuario', function(e) {
          objeto[0].y = e.obje.y
          //console.log(e.obje.y);
        });

        socket.on('nueva esfera', function(e) {
          esfera.x = e.x;
          esfera.y = e.y;
        });

        window.setInterval(frame, 1000/55);


        //evento que detecta cuando se presiona una tecla
        document.addEventListener('keydown', function(e) {
          teclado[e.keyCode] = true;
          //console.log(e.keyCode);

        });

        //evento que detecta cuando se deja de presionar una tecla
        document.addEventListener('keyup', function(e) {
          teclado[e.keyCode] = false;
          //console.log(e.keyCode);

        });

        //Funcion que detecte el keycode del teclado (Si presiona flacha arriba es 38, abajo es 40)
        function move(obj) {
          if(teclado[38]) {
            obj.y -= 6;
            if(obj.y < 0) obj.y = 10;
            socket.emit('usuario', {obje: obj, tecl: teclado});
          }

          if(teclado[40]) {
            var limite = canvas.height - obj.height;
            obj.y += 6;
            if(obj.y > limite) obj.y = limite - 10;
            socket.emit('usuario', {obje: obj, tecl: teclado});
            //console.log(obj.y);
          }

          //Damos movimiento a la esfera
          if( esfera.x >= 990 || esfera.x <= 10 )
             esfera.movx = esfera.movx*-1;
          if( esfera.y >= 590 || esfera.y <= 10 )
             esfera.movy = esfera.movy*-1;
          esfera.x = esfera.x+esfera.movx;
          esfera.y = esfera.y+esfera.movy;

          //Sencilla funcion para crear la colision entre la esfera y el rectangulo
          if ((ball.x > lPaddle.x)&&(ball.x < lPaddle.x+lPaddle.width) &&
                (ball.y+20 > lPaddle.y)&&(ball.y < lPaddle.y+lPaddle.height)){
            //Aqui existe colision
            //console.log('true');

          }else {
            //No tenemos colision
            //console.log('false');
          }
          socket.emit('esfera', {x: esfera.x, y: esfera.y});

          console.log('Esfera en X: ' + esfera.x);

        }



        function frame() {
          move(objeto[0]); //Los cambios de configuracion en las propiedades deben estar arriba
          update(objeto, ctx);
        }

      }
    </script>
  </body>
</html>
